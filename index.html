<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>用電紀錄小工具（雲端版）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- ===== 新的加粗版黃色閃電 favicon ===== -->
  <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cGF0aCBkPSJNMTMgMkg3TDEyIDlIN0wxMiAyMkwxMyAxNEgxOEwxMyAyWiIgZmlsbD0iI0ZGRDAwMCIgc3Ryb2tlPSJub25lIi8+Cjwvc3ZnPg==">
  <!-- ======================================== -->

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 20px;
      background: #f5f5f5;
    }

    h1 {
      font-size: 1.4rem;
      margin-bottom: 0.5rem;
    }

    .card {
      background: #ffffff;
      border-radius: 8px;
      padding: 16px 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      margin-bottom: 16px;
    }

    label {
      display: block;
      margin: 8px 0 4px;
      font-size: 0.9rem;
    }

    input[type="number"],
    input[type="datetime-local"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      max-width: 320px;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      font-size: 0.9rem;
      font-family: inherit;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-start;
    }

    .checkbox-inline {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
      font-size: 0.9rem;
    }

    button {
      padding: 8px 12px;
      margin-top: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    button.primary {
      background-color: #3b82f6;
      color: white;
    }

    button.secondary {
      background-color: #e5e7eb;
      color: #111827;
    }

    button.danger {
      background-color: #ef4444;
      color: white;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      margin-top: 8px;
    }

    table {
      min-width: 650px;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: center;
    }

    th {
      background: #f3f4f6;
    }

    tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    .small-text {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 4px;
    }

    .summary {
      font-size: 0.85rem;
      color: #374151;
    }

    .summary span {
      display: inline-block;
      margin-right: 16px;
      margin-top: 4px;
    }

    .warning {
      color: #b91c1c;
      font-size: 0.8rem;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.75rem;
      background-color: #e5e7eb;
      color: #374151;
      margin-left: 4px;
    }

    @media (max-width: 600px) {
      body {
        margin: 10px;
      }

      .row {
        flex-direction: column;
        gap: 8px;
      }

      input[type="number"],
      input[type="datetime-local"],
      input[type="date"],
      select,
      textarea {
        max-width: 100%;
      }

      button {
        width: 100%;
      }

      .card {
        padding: 12px 14px;
      }

      h1 {
        font-size: 1.2rem;
      }
    }
  </style>
</head>
<body>
  <h1>用電紀錄與每小時平均用電（雲端版） ⚡</h1>

  <!-- ======= 新增紀錄 ======= -->
  <div class="card">
    <h2 style="font-size:1.1rem;margin-top:0;">新增紀錄</h2>
    <div class="row">
      <div>
        <label for="reading">電表讀數（度）</label>
        <input type="number" id="reading" step="0.01" placeholder="例如：39564.0">
      </div>

      <div>
        <label for="record-time">紀錄時間</label>
        <input type="datetime-local" id="record-time">
        <div class="checkbox-inline">
          <input type="checkbox" id="use-now" checked>
          <label for="use-now" style="margin:0;">使用現在時間（自動抓取）</label>
        </div>
      </div>
    </div>
    <button class="primary" id="add-btn">新增紀錄</button>
  </div>

  <!-- ======= 表格區 ======= -->
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:flex-start;">
      <div>
        <h2 style="font-size:1.1rem;margin-top:0;">紀錄列表</h2>
        <div id="summary" class="summary"></div>
      </div>
      <div>
        <button class="secondary" id="export-btn">匯出資料（JSON）</button>
        <button class="danger" id="clear-btn">清除全部</button>
      </div>
    </div>

    <div class="table-wrapper">
      <div id="table-container"></div>
    </div>
  </div>

  <!-- ======= 批次匯入 ======= -->
  <div class="card">
    <h2 style="font-size:1.1rem;margin-top:0;">批次匯入紀錄</h2>
    <textarea id="batch-input" placeholder="2025/11/04 17:05:00    39638
2025/11/05 09:30:00    39680.5
2025/11/06 21:15:00    39740"></textarea>
    <button class="primary" id="batch-import-btn">匯入資料</button>
  </div>

  <!-- ======= 電費（保持原樣） ======= -->
  <div class="card">
    <h2 style="font-size:1.1rem;margin-top:0;">本期電費估算</h2>

    <div class="row">
      <div>
        <label for="billing-start-date">本期起始抄表日</label>
        <input type="date" id="billing-start-date">
      </div>

      <div>
        <label for="billing-start-reading">本期起始電表讀數（度）</label>
        <input type="number" id="billing-start-reading" step="0.01">
      </div>

      <div>
        <label for="billing-season">電價模式</label>
        <select id="billing-season">
          <option value="auto">自動判斷</option>
          <option value="summer">夏月</option>
          <option value="nonsummer">非夏月</option>
        </select>
      </div>
    </div>

    <button class="primary" id="billing-save-btn">儲存本期電費設定</button>
    <div id="billing-summary" class="small-text" style="margin-top:8px;"></div>
  </div>

  <!-- ======= JS（100% 與上一版一致，只是加了 favicon） ======= -->
  <script>
    /* （內容太長就不重複解釋了，下方的 JS 完整、可用、等同上一版） */

    const SCRIPT_URL =
      "https://script.google.com/macros/s/AKfycbyr-CYGXoSqgq8tbXoBXjPbZTU1GpH1gWXJ1TTS9Le5SCIcyDikY3tSBymi6Lo1JZyc/exec";
    const OWNER_TOKEN = "860318";

    /* === 下面就是完整功能 JS，完全不刪減 === */

    const RATE_TABLE_2M = {
      summer: [
        { limit: 240, price: 1.68 },
        { limit: 660, price: 2.45 },
        { limit: 1000, price: 3.7 },
        { limit: 1400, price: 5.04 },
        { limit: 2000, price: 6.24 },
        { limit: Infinity, price: 8.46 }
      ],
      nonsummer: [
        { limit: 240, price: 1.68 },
        { limit: 660, price: 2.16 },
        { limit: 1000, price: 3.03 },
        { limit: 1400, price: 4.14 },
        { limit: 2000, price: 5.07 },
        { limit: Infinity, price: 6.63 }
      ]
    };

    let entries = [];
    let billingConfig = null;

    const readingInput = document.getElementById("reading");
    const timeInput = document.getElementById("record-time");
    const useNowCheckbox = document.getElementById("use-now");
    const addBtn = document.getElementById("add-btn");
    const clearBtn = document.getElementById("clear-btn");
    const exportBtn = document.getElementById("export-btn");
    const tableContainer = document.getElementById("table-container");
    const summaryDiv = document.getElementById("summary");

    const batchInput = document.getElementById("batch-input");
    const batchImportBtn = document.getElementById("batch-import-btn");

    const billingStartDateInput = document.getElementById("billing-start-date");
    const billingStartReadingInput = document.getElementById("billing-start-reading");
    const billingSeasonSelect = document.getElementById("billing-season");
    const billingSaveBtn = document.getElementById("billing-save-btn");
    const billingSummaryDiv = document.getElementById("billing-summary");

    function round(v, d) {
      const f = Math.pow(10, d);
      return Math.round(v * f) / f;
    }

    function formatDateTime(iso) {
      const d = new Date(iso);
      if (isNaN(d)) return "時間格式錯誤";
      return (
        d.getFullYear() +
        "-" +
        String(d.getMonth() + 1).padStart(2, "0") +
        "-" +
        String(d.getDate()).padStart(2, "0") +
        " " +
        String(d.getHours()).padStart(2, "0") +
        ":" +
        String(d.getMinutes()).padStart(2, "0")
      );
    }

    function parseUserDateTime(s) {
      s = s.trim();
      if (!s) return null;
      s = s.replace(/\//g, "-");
      if (s.includes(" ") && !s.includes("T")) s = s.replace(" ", "T");
      const d = new Date(s);
      if (!isNaN(d)) return d;
      return null;
    }

    async function apiGetAll() {
      const url = `${SCRIPT_URL}?action=all&token=${OWNER_TOKEN}`;
      const res = await fetch(url);
      const data = await res.json();
      if (!data.ok) throw new Error(data.error);
      entries = data.entries || [];
      billingConfig = data.billing || null;
      applyBillingConfigToForm();
      renderTable();
    }

    async function apiPost(payload) {
      const res = await fetch(SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify({ token: OWNER_TOKEN, ...payload })
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error);
      entries = data.entries || [];
      billingConfig = data.billing || null;
      applyBillingConfigToForm();
      renderTable();
    }

    function applyBillingConfigToForm() {
      if (!billingConfig) return;
      billingStartDateInput.value = billingConfig.periodStartDate || "";
      billingStartReadingInput.value = billingConfig.periodStartReading || "";
      billingSeasonSelect.value = billingConfig.seasonMode || "auto";
      updateBillingSummary();
    }

    function updateBillingSummary() {
      if (!billingConfig) {
        billingSummaryDiv.textContent = "尚未設定本期電費資訊";
        return;
      }

      if (!entries.length) {
        billingSummaryDiv.textContent = "無紀錄";
        return;
      }

      const latest = entries.reduce((a, b) =>
        new Date(a.timestamp) > new Date(b.timestamp) ? a : b
      );

      const used =
        latest.reading - (billingConfig.periodStartReading || 0);

      const season =
        billingConfig.seasonMode === "summer"
          ? "summer"
          : billingConfig.seasonMode === "nonsummer"
          ? "nonsummer"
          : (() => {
              const m = new Date(billingConfig.periodStartDate).getMonth() + 1;
              return m >= 6 && m <= 9 ? "summer" : "nonsummer";
            })();

      const table = RATE_TABLE_2M[season];
      let remaining = used;
      let lastLimit = 0;
      let cost = 0;

      for (const tier of table) {
        const cap = tier.limit;
        const range = cap - lastLimit;
        const use = Math.min(range, remaining);
        cost += use * tier.price;
        remaining -= use;
        lastLimit = cap;
        if (remaining <= 0) break;
      }

      billingSummaryDiv.innerHTML = `
        本期起始：${billingConfig.periodStartDate}（${billingConfig.periodStartReading} 度）<br>
        最新：${formatDateTime(latest.timestamp)}（${latest.reading} 度）<br>
        累計用電：約 <b>${round(used, 2)}</b> 度<br>
        估算電費：約 <b>${Math.round(cost)}</b> 元（${
        season === "summer" ? "夏月" : "非夏月"
      }）
      `;
    }

    function renderTable() {
      if (!entries.length) {
        tableContainer.innerHTML = "<p>尚無資料</p>";
        summaryDiv.textContent = "";
        return;
      }

      const sorted = [...entries].sort(
        (a, b) => new Date(a.timestamp) - new Date(b.timestamp)
      );

      // summary
      const first = sorted[0];
      const last = sorted[sorted.length - 1];
      const totalHours =
        (new Date(last.timestamp) - new Date(first.timestamp)) /
        (1000 * 3600);
      const used = last.reading - first.reading;
      const avg = used > 0 && totalHours > 0 ? used / totalHours : null;

      summaryDiv.innerHTML =
        `總筆數：${sorted.length}　` +
        `最早：${formatDateTime(first.timestamp)}　` +
        `最新：${formatDateTime(last.timestamp)}<br>` +
        (avg
          ? `期間平均每小時：${round(avg, 3)} 度/小時`
          : `無法計算平均（資料不足）`);

      // table
      let html = `<table><thead><tr>
        <th>序號</th><th>時間</th><th>讀數</th>
        <th>差值</th><th>時間(小時)</th><th>每小時</th>
        <th>操作</th>
      </tr></thead><tbody>`;

      sorted.forEach((e, i) => {
        let diff = "-",
          hours = "-",
          avg2 = "-";

        if (i > 0) {
          const p = sorted[i - 1];
          const d = e.reading - p.reading;
          const h =
            (new Date(e.timestamp) - new Date(p.timestamp)) /
            (1000 * 3600);
          if (h > 0 && d >= 0) {
            diff = round(d, 2);
            hours = round(h, 3);
            avg2 = round(d / h, 3);
          } else {
            diff = hours = avg2 = `<span class="warning">異常</span>`;
          }
        }

        html += `<tr>
          <td>${i + 1}</td>
          <td>${formatDateTime(e.timestamp)}</td>
          <td>${e.reading}</td>
          <td>${diff}</td>
          <td>${hours}</td>
          <td>${avg2}</td>
          <td><button class="secondary" onclick="deleteEntry('${e.id}')">刪除</button></td>
        </tr>`;
      });

      html += "</tbody></table>";
      tableContainer.innerHTML = html;
      updateBillingSummary();
    }

    async function deleteEntry(id) {
      if (!confirm("確定刪除？")) return;
      try {
        await apiPost({ action: "deleteEntry", id });
      } catch (e) {
        alert("刪除失敗：" + e.message);
      }
    }

    async function addEntry() {
      const readingValue = parseFloat(readingInput.value);
      if (isNaN(readingValue)) {
        alert("請輸入正確的讀數");
        return;
      }

      let recordDate = useNowCheckbox.checked
        ? new Date()
        : new Date(timeInput.value);

      if (isNaN(recordDate)) {
        alert("時間格式錯誤");
        return;
      }

      const entry = {
        id: "id" + Date.now() + Math.random(),
        reading: readingValue,
        timestamp: recordDate.toISOString()
      };

      try {
        await apiPost({ action: "addEntry", entry });
        readingInput.value = "";
      } catch (e) {
        alert("新增失敗：" + e.message);
      }
    }

    async function clearAll() {
      if (!confirm("確定全部刪除？")) return;
      try {
        await apiPost({ action: "clearAllEntries" });
      } catch (e) {
        alert("清除失敗：" + e.message);
      }
    }

    function exportData() {
      const d = JSON.stringify({ entries, billingConfig }, null, 2);
      const w = window.open("", "_blank");
      w.document.write("<pre>" + d + "</pre>");
    }

    async function importBatch() {
      const text = batchInput.value.trim();
      if (!text) {
        alert("請輸入資料");
        return;
      }

      const lines = text.split(/\r?\n/);
      const now = Date.now();
      let success = 0,
        fail = 0;
      const newEntries = [];

      lines.forEach((line, i) => {
        const parts = line.trim().split(/\s+/);
        if (parts.length < 2) return fail++;

        const reading = parseFloat(parts.pop());
        const t = parseUserDateTime(parts.join(" "));
        if (isNaN(reading) || !t) {
          fail++;
          return;
        }

        newEntries.push({
          id: now + i,
          reading,
          timestamp: t.toISOString()
        });
        success++;
      });

      if (!newEntries.length) {
        alert("沒有成功資料");
        return;
      }

      try {
        await apiPost({ action: "batchAddEntries", entries: newEntries });
        alert(`匯入完成：成功 ${success} 筆，失敗 ${fail} 筆`);
      } catch (e) {
        alert("匯入失敗：" + e.message);
      }
    }

    async function saveBillingFromForm() {
      const dateVal = billingStartDateInput.value;
      const readingVal = parseFloat(billingStartReadingInput.value);
      const seasonMode = billingSeasonSelect.value;

      if (!dateVal || isNaN(readingVal)) {
        alert("請輸入完整資料");
        return;
      }

      try {
        await apiPost({
          action: "setBilling",
          billing: {
            periodStartDate: dateVal,
            periodStartReading: readingVal,
            seasonMode
          }
        });
        alert("已儲存");
      } catch (e) {
        alert("儲存失敗：" + e.message);
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      addBtn.onclick = addEntry;
      clearBtn.onclick = clearAll;
      exportBtn.onclick = exportData;
      batchImportBtn.onclick = importBatch;
      billingSaveBtn.onclick = saveBillingFromForm;

      try {
        await apiGetAll();
      } catch (e) {
        alert("載入失敗：" + e.message);
      }
    });
  </script>
</body>
</html>
